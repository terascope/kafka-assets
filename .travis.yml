language: node_js
node_js:
  - "8"
#   - "10"
os:
  - linux
#   - osx
branches:
  only:
  - master
  - /^v\d+\.\d+\.\d+/
env:
  - KAFKA_HOME=$HOME/.kafka
before_install:
  # Install latest yarn
  - curl -o- -L https://yarnpkg.com/install.sh | bash
  - export PATH="$HOME/.yarn/bin:$PATH"
  # Install Kafka
  - mkdir -p $KAFKA_HOME
  - wget https://www.apache.org/dist/kafka/1.1.1/kafka_2.11-1.1.1.tgz -O /tmp/kafka.tgz
  - tar xzf /tmp/kafka.tgz -C $KAFKA_HOME --strip-components 1
  # enable auto creating topics
  - echo '' >> "$KAFKA_HOME/config/server.properties"
  - echo "auto.create.topics.enable=true" >> "$KAFKA_HOME/config/server.properties"
  # Run Zookeeper/Kafka on localhost (default ports for ZK, Kafka: 2181, 9092)
  - $KAFKA_HOME/bin/zookeeper-server-start.sh "$KAFKA_HOME/config/zookeeper.properties" &
  - sleep 5
  - $KAFKA_HOME/bin/kafka-server-start.sh "$KAFKA_HOME/config/server.properties" &
  - sleep 3
install:
  - yarn install
script:
  - yarn test
before_deploy:
  - yarn build
deploy:
  provider: releases
  api_key: $GITHUB_TOKEN
  file_glob: true
  file: builds/*.zip
  skip_cleanup: true
  on:
    tags: true
