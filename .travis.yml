# set the dist to bionic
dist: bionic
language: node_js
node_js:
  - '10.19'
  - '12.16'
os:
  - linux
  - osx
osx_image: xcode10
branches:
  only:
  - master
  - /^v\d+\.\d+\.\d+/
addons:
  apt:
    packages:
      - jq
cache:
  npm: false
  yarn: false
if: NOT (branch = master AND type = push AND tag IS blank AND os = osx)
before_install:
  # Install latest yarn
  - curl -o- -L https://yarnpkg.com/install.sh | bash
  - export PATH="$HOME/.yarn/bin:$PATH"
  # brew install openssl seems to be broken now
  # - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install openssl; fi
  # we still need to set the openssl flags for building
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then export CPPFLAGS=-I/usr/local/opt/openssl/include; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then export LDFLAGS=-L/usr/local/opt/openssl/lib; fi
  # Install Kafka
  - export KAFKA_HOME="$HOME/.kafka"
  - export KAFKA_TMP="$HOME/.kafka-downloads"
  - mkdir -p "$KAFKA_HOME"
  - mkdir -p "$KAFKA_TMP"
  - '[[ ! -f "$KAFKA_TMP/kafka.tgz" ]] && wget https://www.apache.org/dist/kafka/2.3.1/kafka_2.11-2.3.1.tgz -O "$KAFKA_TMP/kafka.tgz" || echo "* using cache"'
  - tar xzf "$KAFKA_TMP/kafka.tgz" -C $KAFKA_HOME --strip-components 1
  # add bin to path for ease of use
  - export PATH="$KAFKA_HOME/bin:$PATH"
  # Run Zookeeper on localhost:2181
  - zookeeper-server-start.sh "$KAFKA_HOME/config/zookeeper.properties" > "$KAFKA_HOME/zookeeper.log" &
  - sleep 3
  # Run Kafka on localhost:9092
  - kafka-server-start.sh "$KAFKA_HOME/config/server.properties" > "$KAFKA_HOME/kafka.log" &
  - sleep 3
  # Make it colorful
  - export FORCE_COLOR=1
  # Install teraslice-cli
  - yarn global add teraslice-cli
install:
  - yarn
script:
  - yarn test:all
  - yarn lint
after_success:
  - bash <(curl -s https://codecov.io/bash)
  # Attempt to build the asset (so it doesn't blow up when it deploys)
  - teraslice-cli assets build
after_failure:
  - tail -n 100 $KAFKA_HOME/*.log
before_deploy:
  - teraslice-cli assets build
  - cp ./docs/CONNECTORS.md packages/terafoundation_kafka_connector/README.md
  - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
deploy:
  - provider: script
    skip_cleanup: true
    script: yarn publish:changed
    on:
      tags: true
      condition: $TRAVIS_OS_NAME = linux
  - provider: releases
    api_key: $GITHUB_TOKEN
    prerelease: true
    file_glob: true
    file: build/*.zip
    skip_cleanup: true
    on:
      tags: true
